{% load static %}
<div class="modal" id="productModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; border-radius: var(--radius-lg); max-width: 42rem; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg);">
        <div style="padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; color: var(--color-text);">
                    {% if action == 'create' %}Ajouter un produit{% else %}Modifier le produit{% endif %}
                </h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-light);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="productForm" method="post" enctype="multipart/form-data" action="{% if action == 'create' %}{% url 'galerie:product_create' %}{% else %}{% url 'galerie:product_update' product.id %}{% endif %}" onsubmit="submitProductForm(event)">
                {% csrf_token %}
                {% if action == 'update' %}
                <input type="hidden" name="product_id" value="{{ product.id }}">
                {% endif %}
                <div class="form-group">
                    <label class="form-label">{{ form.name.label }} *</label>
                    {{ form.name }}
                    {{ form.name.errors }}
                </div>
                
                <div class="form-group">
                    <label class="form-label">{{ form.category.label }} *</label>
                    {{ form.category }}
                    {{ form.category.errors }}
                    <div style="margin-top: 0.5rem;">
                        <button type="button" onclick="openCategoryModal()" class="btn btn-outline" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                            <i class="fas fa-plus"></i> Nouvelle catégorie
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">{{ form.description.label }} *</label>
                    {{ form.description }}
                    {{ form.description.errors }}
                </div>
                
                <div class="form-group">
                    <label class="form-label">{{ form.details.label }} *</label>
                    {{ form.details }}
                    {{ form.details.errors }}
                </div>
                
                <div class="form-group">
                    <label class="form-label">{{ form.price.label }} (XOF) *</label>
                    {{ form.price }}
                    {{ form.price.errors }}
                </div>
                
                <div class="form-group">
                    <label class="form-label">{{ form.image.label }}</label>
                    {{ form.image }}
                    {{ form.image.errors }}
                    {% if product and product.image %}
                        <div style="margin-top: 0.5rem;">
                            <img src="{{ product.image.url }}" alt="Image actuelle" style="max-width: 200px; border-radius: var(--radius);">
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">{{ form.image_url.label }}</label>
                    {{ form.image_url }}
                    <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: 0.25rem;">
                        Utilisez cette option si vous n'avez pas d'image à uploader
                    </p>
                    {{ form.image_url.errors }}
                </div>
                
                <div class="form-group">
                    <label class="form-label">{{ form.stock.label }} *</label>
                    {{ form.stock }}
                    <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: 0.25rem;">
                        Nombre d'unités disponibles en stock
                    </p>
                    {{ form.stock.errors }}
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        {{ form.availability }}
                        <span>{{ form.availability.label }}</span>
                    </label>
                    {{ form.availability.errors }}
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                    <button type="button" onclick="closeModal()" class="btn btn-outline">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function closeModal() {
    const modal = document.getElementById('productModal');
    if (modal) {
        modal.style.display = 'none';
        // Réactiver le scroll du body
        document.body.style.overflow = '';
        // Nettoyer CKEditor si présent
        if (typeof CKEDITOR !== 'undefined' && CKEDITOR.instances['id_details']) {
            CKEDITOR.instances['id_details'].destroy();
        }
    }
}

// Fermer le modal en cliquant en dehors (ajouté une seule fois)
(function() {
    const modal = document.getElementById('productModal');
    if (modal) {
        // Supprimer les anciens listeners si présents
        const newModal = modal.cloneNode(true);
        modal.parentNode.replaceChild(newModal, modal);
        // Ajouter le nouveau listener
        newModal.addEventListener('click', function(event) {
            if (event.target === newModal) {
                closeModal();
            }
        });
    }
})();

function openCategoryModal() {
    // Ouvrir le modal de catégorie
    const categoryUrl = '{% url "galerie:category_create" %}';
    fetch(categoryUrl, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur HTTP: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.html) {
            document.getElementById('categoryModalContainer').innerHTML = data.html;
            const modal = document.getElementById('categoryModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        } else {
            alert('Erreur: Impossible de charger le formulaire de catégorie');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Une erreur est survenue lors du chargement du formulaire de catégorie');
    });
}

function submitProductForm(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Récupérer le contenu de CKEditor si présent
    if (typeof CKEDITOR !== 'undefined' && CKEDITOR.instances['id_details']) {
        const editorContent = CKEDITOR.instances['id_details'].getData();
        formData.set('details', editorContent);
    }
    
    // Récupérer l'URL d'action depuis le formulaire ou construire depuis l'URL actuelle
    let actionUrl = form.action;
    if (!actionUrl || actionUrl === '') {
        // Construire l'URL depuis l'URL du modal
        const urlParts = window.location.pathname.split('/');
        if (form.dataset.productId) {
            actionUrl = `/dashboard/produit/${form.dataset.productId}/modifier/`;
        } else {
            actionUrl = '/dashboard/produit/creer/';
        }
    }
    
    fetch(actionUrl, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'Produit enregistré avec succès !');
            closeModal();
            location.reload();
        } else {
            // Afficher les erreurs de formulaire
            if (data.html) {
                document.getElementById('productModalContainer').innerHTML = data.html;
                // Réinitialiser CKEditor après le rechargement du HTML
                setTimeout(initCKEditor, 100);
            } else {
                let errorMsg = 'Erreur: ';
                if (data.errors) {
                    errorMsg += Object.values(data.errors).flat().join(', ');
                } else {
                    errorMsg += (data.message || 'Une erreur est survenue');
                }
                alert(errorMsg);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Une erreur est survenue lors de l\'envoi du formulaire');
    });
}

// Initialiser CKEditor quand le modal est ouvert
function initCKEditor() {
    if (typeof CKEDITOR !== 'undefined') {
        const detailsField = document.querySelector('#id_details');
        if (detailsField) {
            // Détruire l'instance existante si présente
            if (CKEDITOR.instances['id_details']) {
                CKEDITOR.instances['id_details'].destroy();
            }
            // Créer une nouvelle instance
            CKEDITOR.replace('id_details', {
                height: 300,
                toolbar: [
                    { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike'] },
                    { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Blockquote'] },
                    { name: 'links', items: ['Link', 'Unlink'] },
                    { name: 'insert', items: ['Image'] },
                    { name: 'styles', items: ['Format', 'Font', 'FontSize'] },
                    { name: 'colors', items: ['TextColor', 'BGColor'] },
                    { name: 'tools', items: ['Maximize', 'Source'] }
                ],
                language: 'fr'
            });
        }
    }
}

// Appeler initCKEditor après le chargement du modal
setTimeout(function() {
    initCKEditor();
    // Focus sur le premier champ
    const firstInput = document.querySelector('#productModal input[type="text"], #productModal input[type="number"], #productModal select');
    if (firstInput) {
        firstInput.focus();
    }
}, 300);
</script>

